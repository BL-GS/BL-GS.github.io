<!DOCTYPE html><html class="appearance-auto" lang="en"><head><meta charset="UTF-8"><title>Virtualization Introduction</title><meta name="description" content="This man is too lazy to introduce himself"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/style/common/jquery.fancybox.min.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="定义虚拟化是将单一物理设备模拟为相互隔离的多个虚拟设备，同时保证这些虚拟设备的高效性。
HypervisorHypervisor 也成为 VMM(virtual machine monitor) 虚拟机管理程序，负责与不同虚拟机之间打交道。在没有虚拟化硬件扩展的情况下 guest OS 和 guest application 都需要在 非特权 de-privileged 模式下运行，此时 Hypervisor 跑在特权模式下，负责管理硬件资源，与 VM 互动。
特权指令Popek 和 Goldberg 有一篇虚拟化的经典论文，把需要在特权模式下执行的指令分成了两类：

sensitive instructions 敏感指令：操作特权资源的指令，包括修改虚拟机的运行模式或者下面物理机的状态；读写时钟、中断等寄.."><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">Xinrui Zheng's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Virtualization Introduction</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Click back to the top</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89"><span class="toc-text">定义</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Hypervisor"><span class="toc-text">Hypervisor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E6%9D%83%E6%8C%87%E4%BB%A4"><span class="toc-text">特权指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E6%9D%83%E6%8E%A5%E8%A7%A6%E5%92%8C%E9%99%B7%E5%85%A5%E6%A8%A1%E6%8B%9F"><span class="toc-text">特权接触和陷入模拟</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="toc-text">虚拟化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%8C%E5%85%A8%E8%99%9A%E6%8B%9F%E5%8C%96-Pure-virtualization"><span class="toc-text">完全虚拟化 Pure virtualization</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%8A%E8%99%9A%E6%8B%9F%E5%8C%96-para-virtualization"><span class="toc-text">半虚拟化 para-virtualization</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%91%E5%B1%95%E5%8E%86%E5%8F%B2"><span class="toc-text">发展历史</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-text">问题</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/Virtualization"><i class="tag post-item-tag">Virtualization</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">Virtualization Introduction</h1><time class="has-text-grey" datetime="2023-08-13T14:00:11.686Z">2023-08-13</time><article class="mt-2 post-content"><h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>虚拟化是将单一物理设备模拟为相互隔离的多个虚拟设备，同时保证这些虚拟设备的高效性。</p>
<h3 id="Hypervisor"><a href="#Hypervisor" class="headerlink" title="Hypervisor"></a>Hypervisor</h3><p>Hypervisor 也成为 VMM(virtual machine monitor) 虚拟机管理程序，负责与不同虚拟机之间打交道。<br>在没有虚拟化硬件扩展的情况下 guest OS 和 guest application 都需要在 非特权 de-privileged 模式下运行，此时 Hypervisor 跑在特权模式下，负责管理硬件资源，与 VM 互动。</p>
<h3 id="特权指令"><a href="#特权指令" class="headerlink" title="特权指令"></a>特权指令</h3><p>Popek 和 Goldberg 有一篇虚拟化的经典论文，把需要在特权模式下执行的指令分成了两类：</p>
<ul>
<li><strong>sensitive instructions 敏感指令</strong>：操作特权资源的指令，包括修改虚拟机的运行模式或者下面物理机的状态；读写时钟、中断等寄存器；访问存储保护系统、地址重定位系统及所有的I&#x2F;O指令。</li>
<li><strong>privileged instructions 特权指令</strong>：系统中有一些操作和管理关键系统资源的指令，这些指令只有在最高特权级上能够正确运行。如果在非最高特权级上运行，特权指令会引发一个异常，处理器会陷入到最高特权级，交由系统软件处理了。</li>
</ul>
<p>其中，敏感指令是特权指令的子集。这种标准被称为 classically virtualized 经典可虚拟化模型。</p>
<h3 id="特权接触和陷入模拟"><a href="#特权接触和陷入模拟" class="headerlink" title="特权接触和陷入模拟"></a>特权接触和陷入模拟</h3><p>虚拟化场景下，要求 GuestOS 内核的特权解除。当其需要执行特权指令时，会产生 trap，被 VMM 捕获并由 VMM 完成。这就是 **特权解除和陷入模拟(Privilege deprivileging&#x2F;Trap-and-Emulation)**。</p>
<blockquote>
<p> 对于一般 RISC 处理器，如 MIPS，PowerPC 以及SPARC，敏感指令肯定是特权指令，但是x86 例外，x86绝大多数的敏感指令是特权指令，但是由于部分敏感指令不是特权指令，执行这些指令的时候不会自动trap被VMM捕获。</p>
</blockquote>
<h3 id="虚拟化"><a href="#虚拟化" class="headerlink" title="虚拟化"></a>虚拟化</h3><h4 id="完全虚拟化-Pure-virtualization"><a href="#完全虚拟化-Pure-virtualization" class="headerlink" title="完全虚拟化 Pure virtualization"></a>完全虚拟化 Pure virtualization</h4><p>完全虚拟化要求硬件架构是可虚拟化的，当 捕获(trap) 进入 hypervisor 后，由 hypervisor 去模拟敏感指令的执行，这项技术也被称为陷入模式(trap-and-emulate)。当一个 guest OS 想要去访问特权资源（物理外设），就会产生一个 trap 唤醒 hypervisor，hypervisor 去模拟这个访问，然后返回到 guest OS 的下一条指令去继续执行。</p>
<p>其采用了<strong>优先级压缩技术 Ring Compression</strong> 和 <strong>二进制代码翻译技术 Binary Translation</strong><br>优先级压缩技术使得 VMM 和 Guest 分别运行在不同特权级下。 对x86架构而言，即VMM运行在最高特权级别Ring 0下，Guest OS运行在Ring 1下，用户应用运行在Ring 3下。因此，Guest OS的核心指令无法直接下达到计算机系统硬件执行，而是需要经过VMM的捕获和模拟执行（部分难以虚拟化的指令需要通过二进制翻译技术进行转换）。</p>
<h4 id="半虚拟化-para-virtualization"><a href="#半虚拟化-para-virtualization" class="headerlink" title="半虚拟化 para-virtualization"></a>半虚拟化 para-virtualization</h4><p>半虚拟化通过修改 guest OS 的源码，使其避免难以虚拟化的指令（虚拟化漏洞）。操作系统通常会使用到处理器提供的全部功能，例如特权级别、地址空间和控制寄存器等。类虚拟化首先要解决的问题就是如何陷入VMM。典型的做法是修改 guest OS 的相关代码，让 os主动让出特权级别，而运行在次一级特权上。而当 guest OS 需要执行特权指令时，触发保护机制并通过 VMM 模拟。</p>
<p>半虚拟化通常能够达到比全虚拟化更好的性能，但是需要修改 OS 源码，而非运行时译码和处理。</p>
<blockquote>
<p>其与 partial-virtualization 有些差异，这只虚拟化部分外设来满足某些专门的软件的执行环境，但是不能运行所有可能运行在物理机上的软件。</p>
</blockquote>
<h2 id="发展历史"><a href="#发展历史" class="headerlink" title="发展历史"></a>发展历史</h2><p>从虚拟化概念的提出，虚拟化技术经过了三个阶段的进化。</p>
<p><strong>第一个阶段</strong>，所有的虚拟管理程序(hypervisor)在内核态实现，实现对稀缺资源的多路复用。例如 IBM VM&#x2F;370。<br><strong>第二个阶段</strong>，主流的虚拟机管理程序将管理函数的实现迁移到用户态，通过系统调用在宿主操作系统上做文章。然而，一些功能仍然需要到内核态进行，比如指令模拟和虚拟内存。<br><strong>第三个阶段</strong>，一些厂商开始从硬件层面支持虚拟化（Intel VMX 和 AMD SVM），进一步降低了虚拟化中内核操作的占比，将这一部分功能转由硬件代为实现，提高了性能。</p>
<p>现在很多基于硬件扩展的虚拟机管理程序分为两部分组成：**内核模式的模块(kernel-mode module)<strong>和</strong>用户模式的模块(user-mode helper)**。比如，经典的 Linux&#x2F;KVM-based 虚拟化系统就包含了一个 KVM 内核模块，同时对每个 VM 有一个用户态的 helper，比如 QEMU。其中，KVM 模块和硬件扩展和宿主内核打交道，用户模块则负责 VM 的管理和 IO 虚拟化。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>虚拟化系统内核态的组件总是会有各种各样的问题，威胁到主机的安全。比如在 KVM 的发展中就有了上百个 CVE 漏洞报告。这些漏洞可能被利用从而进行 Denial of Service(DoS) 攻击。一旦 KVM 的内核模块被黑入了，那么其上运行的各个虚拟机都难逃其难。</p>
<blockquote>
<p>CVE（Common Vulnerabilities and Exposures）的全称是公共漏洞和暴露，是公开披露的网络安全漏洞列表。IT人员、安全研究人员查阅CVE获取漏洞的详细信息，进而根据漏洞评分确定漏洞解决的优先级。</p>
</blockquote>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2023/08/16/CPUVirtualization/" title="CPU Virtualization"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">Previous: CPU Virtualization</span></a><a class="button is-default" href="/2023/08/09/2PL/" title=""><span class="has-text-weight-semibold">Next: </span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="BL-GS/BLGS.github.io" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/BL-GS"><i class="iconfont icon-github"></i></a><!-- Ins--><!-- RSS--><!-- 知乎--><a title="zhihu" target="_blank" rel="noopener nofollow" href="//zhihu.com/https://www.zhihu.com/people/blgs"><i class="iconfont icon-zhihu"></i></a><!-- 领英--><!-- 脸书--></section><p><span>Copyright ©</span><span> Xinrui Zheng 2023</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/jquery-3.6.1.min.js"></script><script src="/js/jquery-fancybox.min.js"></script><script src="/js/img_zoom.js"></script><script src="/js/post.js"></script></body></html>