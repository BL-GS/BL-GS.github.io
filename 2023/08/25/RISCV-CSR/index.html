<!DOCTYPE html><html class="appearance-auto" lang="en"><head><meta charset="UTF-8"><title>RISC-V CSR Introduction</title><meta name="description" content="This man is too lazy to introduce himself"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/style/common/jquery.fancybox.min.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="RISC-V ISA 中，SYSTEM 类 opcode 被用来编码所有的特权指令。这些指令主要可以分为两类：在 Zicsr 扩展中定义的原子 read-modify-write Control and Status Registers (CSRs) 和其他特权指令。
CSR 寄存器仅允许对应特权级或者更高特权级下的访问。对于标准的 CSR 寄存器，读不会产生副作用，但是写会产生副作用。
CSR 地址映射规则标准 RISC-V ISA 预留 12 位编码空间 csr[11:0] 可以支持多达 4096 个 CSRs。一般来说：

csr[11:8] 用来指示特定特权级下 CSRs 是否可读或者可写
csr[11:10] 用来只是寄存器是否是只读(11) 或者可读写的(00, 01, 10)
csr[9:8].."><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">Xinrui Zheng's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">RISC-V CSR Introduction</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Click back to the top</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#CSR-%E5%9C%B0%E5%9D%80%E6%98%A0%E5%B0%84%E8%A7%84%E5%88%99"><span class="toc-text">CSR 地址映射规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CSR-Field-%E8%A7%84%E8%8C%83"><span class="toc-text">CSR Field 规范</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CSR-Field-%E8%B0%83%E6%95%B4"><span class="toc-text">CSR Field 调整</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Implicit-Reads-of-CSRs"><span class="toc-text">Implicit Reads of CSRs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CSR-%E5%AE%BD%E5%BA%A6%E8%B0%83%E6%95%B4"><span class="toc-text">CSR 宽度调整</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/RISC-V"><i class="tag post-item-tag">RISC-V</i></a><a href="/tags/Hardware"><i class="tag post-item-tag">Hardware</i></a><a href="/tags/Privileged%20mode"><i class="tag post-item-tag">Privileged mode</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">RISC-V CSR Introduction</h1><time class="has-text-grey" datetime="2023-08-25T06:30:06.391Z">2023-08-25</time><article class="mt-2 post-content"><p>RISC-V ISA 中，SYSTEM 类 opcode 被用来编码所有的特权指令。这些指令主要可以分为两类：<br>在 Zicsr 扩展中定义的原子 read-modify-write <strong>Control and Status Registers (CSRs)</strong> 和其他特权指令。</p>
<p>CSR 寄存器仅允许对应特权级或者更高特权级下的访问。对于标准的 CSR 寄存器，读不会产生副作用，但是写会产生副作用。</p>
<h2 id="CSR-地址映射规则"><a href="#CSR-地址映射规则" class="headerlink" title="CSR 地址映射规则"></a>CSR 地址映射规则</h2><p>标准 RISC-V ISA 预留 12 位编码空间 <code>csr[11:0]</code> 可以支持多达 4096 个 CSRs。一般来说：</p>
<ul>
<li><code>csr[11:8]</code> 用来指示特定特权级下 <strong>CSRs 是否可读或者可写</strong></li>
<li><code>csr[11:10]</code> 用来只是寄存器是否是只读(11) 或者可读写的(00, 01, 10)</li>
<li><code>csr[9:8]</code> 用来指示访问该寄存器的最低特权级</li>
<li>M mode 下标准读写 CSRs 0x7A0-0x7BF 是保留给调试用的。其中 0x7A0-0x7AF 可以在 M mode 下访问，但是 0x7B0-0x7BF 只对 debug mode 可见。</li>
</ul>
<blockquote>
<p><strong>Exception</strong><br>尝试访问不存在的 CSR 会导致 <em>illegal instruction exception</em>。<br>尝试在不当的特权级下访问 CSR 或者写一个只读寄存器会导致 <em>illegal instruction exception</em>。<br>M mode 下访问 0x7B0-0x7BF 的 CSRs 应该导致 <em>illegal instruction exception</em><br>一些可读写寄存器可能包含若干个只读位，对这些位的写入会被忽略</p>
</blockquote>
<h2 id="CSR-Field-规范"><a href="#CSR-Field-规范" class="headerlink" title="CSR Field 规范"></a>CSR Field 规范</h2><p><strong>Reserved Writes Preserve Valuds, Reads Ignore Values (WPRI)</strong></p>
<p>这些是一些预留的可读&#x2F;写寄存器。软件可以忽略它的值，在写其他 fields 时也需要保留这些 field 的值，将其赋值为只读的全 0，以实现向前兼容。</p>
<p><strong>Write&#x2F;Read Only Legal Values (WLRL)</strong></p>
<p>这些 read&#x2F;write CSRs 只对一个编码子集做了行为规定，其他的编码功能保留。软件也不应该写入未定义的编码，同时不该假定读取的值都是合法的。或者寄存器在另一套操作集合后是否被写入。</p>
<p>当一个指令尝试为其赋值一个未定义值，可以但不要求引出 <em>illegal instruction exception</em>。在写入非法值之后，读取结果是未定义的，但是应该取决于这次写入或者之前的合法写入。</p>
<p><strong>Write Any Values, Reads Legal Values (WARL)</strong></p>
<p>这些 read&#x2F;write CSRs 只对一个编码子集做了行为规定，其他的编码功能保留，但是能够保证所有读取的值都是合法的。</p>
<p>假设写入的 CSR 没有其他副作用，可以通过写入值，然后读出判断是否相同，从而得到是否支持该值。</p>
<p>写入未定义值时，不会导致异常，但是在读的时候，只会返回最后一次写入的合法值，取决于这次写入或者之前的合法写入。</p>
<h2 id="CSR-Field-调整"><a href="#CSR-Field-调整" class="headerlink" title="CSR Field 调整"></a>CSR Field 调整</h2><p>如果对 CSRs 的写入改变了其他 CSR 的合法值，那么除非特殊定义，这个 CSR field 就会立即从一个新的合法值得到一个 UNSPECIFIED 值。</p>
<h2 id="Implicit-Reads-of-CSRs"><a href="#Implicit-Reads-of-CSRs" class="headerlink" title="Implicit Reads of CSRs"></a>Implicit Reads of CSRs</h2><p>在实现中，可能需要隐式地读取 CSR 的值，这个时候，除非特殊规定，这个值应该和合法显式读取的结果相同。</p>
<h2 id="CSR-宽度调整"><a href="#CSR-宽度调整" class="headerlink" title="CSR 宽度调整"></a>CSR 宽度调整</h2><p>假如 CSR 的宽度是可变的，可写 field 的值和宽度改变后的 CSR，除非特殊定义，取决于之前 CSR 的值：</p>
<ul>
<li>previous-width CSR 复制到一个相同宽度的临时寄存器里</li>
<li>对于 previous-width 中的只读域，临时寄存器里的相同位置被设置为 0</li>
<li>临时寄存器的宽度变为新的宽度：假如变小了，不重要的 W bits 被保留，重要的 bits 被丢弃；假如变宽了，临时寄存器做 0 扩展</li>
<li>new-width CSR 的每个可写域得到临时寄存器里的相应值</li>
</ul>
<p>由于改变宽度不是对 CSR 的读写，因此不产生副作用</p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2023/08/25/RISCV-Machine-Level%20ISA/" title="RISC-V Machine-Level ISA"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">Previous: RISC-V Machine-Level ISA</span></a><a class="button is-default" href="/2023/08/24/Makefile%20Tutorial/" title="Makefile"><span class="has-text-weight-semibold">Next: Makefile</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="BL-GS/BLGS.github.io" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/BL-GS"><i class="iconfont icon-github"></i></a><!-- Ins--><!-- RSS--><!-- 知乎--><a title="zhihu" target="_blank" rel="noopener nofollow" href="//zhihu.com/https://www.zhihu.com/people/blgs"><i class="iconfont icon-zhihu"></i></a><!-- 领英--><!-- 脸书--></section><p><span>Copyright ©</span><span> Xinrui Zheng 2023</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/jquery-3.6.1.min.js"></script><script src="/js/jquery-fancybox.min.js"></script><script src="/js/img_zoom.js"></script><script src="/js/post.js"></script></body></html>